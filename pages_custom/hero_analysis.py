import streamlit as st
from heroes.main_functions import is_win, format_duration, calculate_kda
from heroes.special_functions import get_contribution_label
from heroes.chart import plot_kda_stats
from datetime import datetime
from heroes.main_function import fetch_matches

def hero_analysis_page():
    st.title("üìä –ê–Ω–∞–ª–∏–∑ –≥–µ—Ä–æ–µ–≤ –≤ Dota 2")

    with st.sidebar:
        hero_id = st.number_input("–í–≤–µ–¥–∏—Ç–µ Hero ID", min_value=1, value=1)
        match_count = st.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π", 10, 50, 100)
        run = st.button("üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å")

    if run:
        matches = fetch_matches(hero_id, match_count)

        if not matches:
            st.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ")
            return

        st.session_state["heroes"] = matches
        st.session_state["hero_id"] = hero_id

    if "heroes" in st.session_state and "hero_id" in st.session_state:
        st.write("–î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å, –º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫")

        matches = st.session_state["heroes"]
        hero_id = st.session_state["hero_id"]

        st.subheader(f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ (Hero ID: {hero_id})")

        for match in matches:
            k, d, a = match["kills"], match["deaths"], match["assists"]
            kda = calculate_kda(k, d, a)
            label = get_contribution_label(k, d, a)
            result = "‚úÖ –ü–æ–±–µ–¥–∞" if is_win(match) else "‚ùå –ü–æ—Ä–∞–∂–µ–Ω–∏–µ"
            duration = format_duration(match['duration'])
            kills = match['kills']
            deaths = match['deaths']
            assists = match['assists']
            start_time = datetime.fromtimestamp(match["start_time"]).strftime("%d.%m.%Y %H:%M")

            st.markdown(f"""
               ### üïπÔ∏è –ú–∞—Ç—á `{match['match_id']}`
               - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: {result}  
               - **–í—Ä–µ–º—è**: `{duration}`
               - **–î–∞—Ç–∞ –∏–≥—Ä—ã: {start_time}**
               - **–£–±–∏–π—Å—Ç–≤–∞**: {kills}  
               - **–°–º–µ—Ä—Ç–∏**: {deaths}  
               - **–ü–æ–º–æ—â–∏**: {assists}  
               - **KDA**: `{k}/{d}/{a}` ‚Üí **{kda:.2f}**  
               - **–û—Ü–µ–Ω–∫–∞ –≤–∫–ª–∞–¥–∞**: {label}  
               ---
               """)

        if st.button("üìà –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ-–æ—Ç—á—ë—Ç"):
            plot_kda_stats(matches, hero_id)

